<!DOCTYPE html>
<meta charset="utf-8" />
<style>
  .background {
    fill: black;
    pointer-events: all;
  }

  #states {
    fill: grey;
  }

  #state-borders {
    fill: none;
    stroke: black;
    /* stroke-width: 1.5px; */
    stroke-linejoin: round;
    stroke-linecap: round;
    pointer-events: none;
  }
</style>
<body>
  <script src="./d3.js" charset="utf-8"></script>
  <script src="//d3js.org/topojson.v1.min.js"></script>
  <script>
    var w = window,
      d = document,
      e = d.documentElement,
      BODY = d.getElementsByTagName("body")[0];
    var width = w.innerWidth || e.clientWidth || BODY.clientWidth;
    var height = w.innerHeight || e.clientHeight || BODY.clientHeight;

    d3.select(window).on("resize", resizing);

    var projection = d3
      .geoMercator()
      .scale(60000)
      .center([139.463191, 35.710335])
      .translate([width / 2, height / 2]);

    var path = d3.geoPath().projection(projection);

    var zoom = d3
      .zoom()
      .scaleExtent([1, 100])
      .on("zoom", function (event) {
        g.selectAll("path").attr("transform", event.transform);
        g.selectAll("circle")
          .attr("transform", event.transform)
          .attr("r", function (d) {
            return (1.2 * Math.sqrt(d.noriire)) / Math.cbrt(event.transform.k);
          })
          .attr("stroke-width", 1 / Math.cbrt(event.transform.k));
        g.selectAll("line")
          .attr("transform", event.transform)
          .attr("stroke-width", 1 / Math.cbrt(event.transform.k));
        g.selectAll("#state-borders").attr(
          "stroke-width",
          1.5 / Math.cbrt(event.transform.k)
        );
      });

    var svg = d3
      .select("body")
      .append("svg")
      .attr("width", width)
      .attr("height", height)
      .attr("x", 0)
      .attr("y", 0);

    var g = svg.append("g").call(zoom);

    g.append("rect")
      .attr("class", "background")
      .attr("width", width)
      .attr("height", height);
    // .attr("stroke", "lightgrey")
    // .attr("stroke-width", 20);
    showMap();

    d3.csv("data.csv").then(function (data) {
      setTimeout(() => {
        showCircle(data);
      }, 250);
    });
    d3.csv("joinWithIdoKeido.csv").then(function (data) {
      console.log(data);
      setTimeout(() => {
        showline(data);
      }, 120);
    });

    function showMap() {
      d3.json("./tokyo.topojson").then(function (tk) {
        var tokyo = topojson.feature(tk, tk.objects.tokyo);

        g.append("g")
          .attr("id", "states")
          .selectAll("path")
          .data(tokyo.features)
          .enter()
          .append("path")
          .attr("d", path);
        // .on("click", clicked);

        g.append("path")
          .datum(
            topojson.mesh(tk, tk.objects.tokyo, function (a, b) {
              return a !== b;
            })
          )
          .attr("id", "state-borders")
          .attr("stroke-width", 1.5)
          .attr("d", path);
      });
    }

    function showline(data) {
      function position(p) {
        p.attr("x1", function (d) {
          return projection([d.fromIdo, d.fromKeido])[0];
        });
        p.attr("y1", function (d) {
          return projection([d.fromIdo, d.fromKeido])[1];
        });
        p.attr("x2", function (d) {
          return projection([d.toIdo, d.toKeido])[0];
        });
        p.attr("y2", function (d) {
          return projection([d.toIdo, d.toKeido])[1];
        });
        p.attr("stroke-width", 1);
      }
      var links = g
        .selectAll("line")
        .data(data)
        .enter()
        .append("line")
        .attr("stroke", "red")
        // .attr("class", "line")
        // .attr("class", function (d) {
        //   return d.from + "_to_" + d.to;
        // })
        .attr("stroke-width", 1)
        .call(position);
    }

    function showCircle(data) {
      function position(p) {
        p.attr("cx", function (d) {
          return projection([d.ido, d.keido])[0];
        });
        p.attr("cy", function (d) {
          return projection([d.ido, d.keido])[1];
        });
        p.attr("r", function (d) {
          return 1.2 * Math.sqrt(d.noriire);
        });
        p.attr("stroke-width", 1);
      }

      var circle = g
        .selectAll("circle")
        .data(data)
        .enter()
        .append("circle")
        .sort(order)
        .attr("class", "circle")
        .attr("fill", "blue")
        .attr("stroke", "white")
        .call(position)
        // .on("mouseover", function (event, d) {
        //   //event忘れないように
        //   tooltip.style("visibility", "visible").html(d.name);
        // })
        // .on("mousemove", function (event, d) {
        //   var [x, y] = projection([d.ido, d.keido]);
        //   tooltip.style("top", y + "px").style("left", x + "px");
        // })
        // .on("mouseout", function (event, d) {
        //   tooltip.style("visibility", "hidden");
        // })
        .on("click", function (event, d) {
          openGoogleMap(d);
        });
      function order(a, b) {
        return b.noriire - a.noriire;
      }
    }

    // function clicked(d) {
    //   var centroid = path.centroid(d),
    //       translate = projection.translate();

    //   projection.translate([
    //     translate[0] - centroid[0] + width / 2,
    //     translate[1] - centroid[1] + height / 2
    //   ]);

    //   zoom.translate(projection.translate());

    //   g.selectAll("path").transition()
    //       .duration(700)
    //       .attr("d", path);
    // }

    function resizing() {
      w = window;
      e = d.documentElement;
      BODY = d.getElementsByTagName("body")[0];
      width = w.innerWidth || e.clientWidth || BODY.clientWidth;
      height = w.innerHeight || e.clientHeight || BODY.clientHeight;
      svg.attr("width", width).attr("height", height);
      svg.selectAll(".background").attr("width", width).attr("height", height);
    }

    function openGoogleMap(d) {
      window.open(
        "https://www.google.co.jp/maps/search/%E3%83%AC%E3%82%B9%E3%83%88%E3%83%A9%E3%83%B3+" +
          d.name
      );
    }
  </script>
</body>
