<html lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>D3 Test</title>
<script type="text/javascript" src="./d3.js"></script>
<style type="text/css">
</style>
</head>
<body>

<script type="text/javascript">
    
within_T_min('1130101', 10);

function within_T_min(startGroupID, T){
    var Adj_list = {}
    var time = {}
    var previousNode = {}
    var groupInfo = {}

    var queue = new pairing_heap();

    new Promise((resolve) => {
        Make_Adj_List();
        console.log(Adj_list);
        resolve();
    }).then(() => {
        dijkstra();
    });

    //return //到達可能駅のリスト

    function Make_Adj_List(){
        d3.csv("../importantData/join.csv").then(function(data){
            data.forEach(function(d){
                if (Adj_list[d.fromGroupID] == undefined){
                    //console.log(d.fromGroupID);
                    Adj_list[d.fromGroupID] = [];
                    groupInfo[d.fromGroupID] = []
                    time[d.fromGroupID] = T + 100;
                    previousNode[d.fromGroupID] = false;
                }
                Adj_list[d.fromGroupID].push([d.toGroupID, d.toID, d.toName, d.routeID, d.routeName, d.time]);
                groupInfo[d.fromGroupID].push([d.fromID, d.fromName, d.routeID, d.routeName])
            });
        });
    }
    function dijkstra(){
        time[startGroupID] = 0;
        console.log(time[startGroupID]);
        previousNode[startGroupID] = "start";

        queue.enqueue(-time[startGroupID], startGroupID);

        while(queue.size() != 0){
            var currentGroupID = queue.dequeue();
            for(var i = 0; i < Adj_list[currentGroupID].length; i++){
                var nextGroupID = Adj_list[currentGroupID][i][0];
                var dt = Adj_list[currentGroupID][i][5];
                if( (time[nextGroupID] > time[currentGroupID] + dt) && (time[currentGroupID] + dt < T)){
                    var UsedRouteName = Adj_list[currentGroupID][i][4]
                    time[nextGroupID] = time[currentGroupID] + dt;
                    previousNode[nextGroupID] = [currentGroupID, UsedRouteName];
                    queue.enqueue(-time[nextGroupID], nextGroupID);

                    console.log(groupInfo[nextGroupID]);
                }
            }

        }
    }
}

// https://qiita.com/330k/items/daa144d82b000c72f774
function pairing_heap(){
    "use strict";
    var _root = null;
    var _size = 0;
    var _merge = function (i, j){
        var ret = null;

        if(i === null) return j;
        if(j === null) return i;

        if(i.p < j.p){
            ret = i;
            i = j;
            j = ret;
        }
        j.next = i.head;
        i.head = j;

        return i;
    };
    var _mergeList = function (s){
        var n = null;
        var a = null;
        var b = null;
        var j = null;

        while(s !== null){
            a = s;
            b = null;
            s = s.next;
            a.next = null;
            if(s !== null){
                b = s;
                s = s.next;
                b.next = null;
            }
            a = _merge(a, b);
            a.next = n;
            n = a;
        }
        while(n !== null){
            j = n;
            n = n.next;
            s = _merge(j, s);
        }
        return s;
    };

    var enqueue = function(priority, value){
        _root = _merge(_root, {
            p: priority,
            v: value,
            next: null,
            head: null
        });
        _size = _size + 1;
    };
    var dequeue = function(){
        var result = null;

        if(_size){
            result = _root.v;
            _root = _mergeList(_root.head);
            _size = _size - 1;

            return result;
        }else{
            return (void 0);
        }
    };
    var top = function(){
        return _root.v;
    };
    var size = function(){
        return _size;
    };

    return {
        name: 'Pairing Heap',
        enqueue: enqueue,
        dequeue: dequeue,
        top: top,
        size: size
    };
}

</script>
</body></html>
